<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>News Energia ‚Äì Eco Power Lab</title>
  <meta name="description" content="Aggiornamenti tecnici su energia rinnovabile, smart home, mobilit√† elettrica e clima. Infinite scroll, fonti verificate." />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --brand:#007ACC;
      --radius:8px;
      --shadow:0 8px 28px rgba(0,0,0,0.08);
      --bg:#f9fbfd;
      --card-bg:#fff;
      --text:#222;
      --muted:#666;
      --small:#999;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    }
    body {margin:0;padding:0;background:var(--bg);color:var(--text);line-height:1.45;}
    .wrapper {max-width:1080px;margin:0 auto;padding:0 12px 80px;}
    h1 {font-size:2.2em;margin:30px 0 10px;}
    .subtitle {margin:0 0 18px;font-size:1em;}
    .filters {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px;}
    .filter-btn {padding:8px 16px;border:1px solid #d9e2ec;border-radius:6px;background:#fff;cursor:pointer;font-size:0.9em;display:flex;align-items:center;gap:6px;transition:all .15s;user-select:none;}
    .filter-btn.active {background:var(--brand);color:#fff;border-color:var(--brand);}
    .category-label {font-size:1.3em;margin:30px 0 6px;display:inline-block;position:relative;padding-bottom:4px;color:var(--brand);}
    .category-label:after {content:"";position:absolute;left:0;bottom:0;height:3px;width:60px;background:var(--brand);border-radius:2px;}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;}
    .card {background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .18s;position:relative;}
    .card:hover {transform:translateY(-2px);}
    .thumb {width:100%;height:150px;object-fit:cover;background:#eee;display:block;}
    .card-content {padding:14px 16px;flex:1;display:flex;flex-direction:column;gap:6px;}
    .card-title {font-size:1em;font-weight:600;margin:0;line-height:1.2;color:#0f3061;text-decoration:none;}
    .meta {font-size:12px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;}
    .source {font-size:11px;color:var(--small);}
    .snippet {margin-top:4px;font-size:0.9em;color:#333;flex:1;}
    .source-badge {background:#f1f5fa;padding:4px 10px;border-radius:999px;font-size:10px;display:inline-block;margin-right:6px;}
    .loader {display:flex;gap:8px;align-items:center;justify-content:center;margin:40px 0;font-weight:600;color:var(--brand);font-size:1em;}
    .loader-dot {width:10px;height:10px;background:var(--brand);border-radius:50%;animation:jump .6s infinite alternate;}
    .loader-dot:nth-child(2){animation-delay:.12s;}
    .loader-dot:nth-child(3){animation-delay:.24s;}
    @keyframes jump {from{transform:translateY(0);opacity:.6;}to{transform:translateY(-6px);opacity:1;}}
    .page-indicator {text-align:center;margin:24px 0 4px;font-size:0.9em;font-weight:600;}
    .no-results {font-size:1em;margin:20px 0;text-align:center;color:var(--muted);}
    .error {background:#ffece6;border:1px solid #ffb3a7;padding:14px;border-radius:6px;margin:20px 0;color:#a33;}
    .sticky-filter {position:sticky;top:0;background:#fff;padding:10px 0 4px;z-index:10;margin:0 -12px 12px;box-shadow:0 4px 16px rgba(0,0,0,0.04);}
    .no-image-box {
      width:100%; height:150px;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,#005f99,#007acc);
      color:#fff; font-size:0.9em; font-weight:700;
      padding:10px; text-align:center; box-sizing:border-box;
    }
    .no-image-box .title {margin:0;line-height:1.2;}
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>News</h1>
    <div class="sticky-filter">
      <div class="filters" aria-label="Filtri categorie">
        <div class="filter-btn active" data-cat="all">Tutte</div>
        <div class="filter-btn active" data-cat="Energia">‚ö° Energia e Rinnovabili</div>
        <div class="filter-btn active" data-cat="SmartHome">üè† Smart Home</div>
        <div class="filter-btn active" data-cat="Mobilita">üöó Mobilit√† Elettrica</div>
        <div class="filter-btn active" data-cat="Clima">üåç Clima & Ambiente</div>
      </div>
    </div>
    <div id="loader" class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div><span style="margin-left:8px;">Caricamento notizie...</span></div>
    <div id="eco-news" style="display:none;"></div>
    <div id="page-info" class="page-indicator" aria-live="polite"></div>
    <div id="end-of-feed" class="no-results" style="display:none;">Hai visto tutte le notizie recenti.</div>
  </div>

  <script>
    const DATA_URL = "https://stecose.github.io/ecopowerlab/news.json";
    const perPage = 5;
    const categoryNames = { Energia:"Energia e Rinnovabili", SmartHome:"Smart Home", Mobilita:"Mobilit√† Elettrica", Clima:"Clima & Ambiente" };
    let state = [], currentPage=1, totalPages=1;
    let filteredCats = new Set(["Energia","SmartHome","Mobilita","Clima"]);
    const loaded = new Set();

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function formatDate(d){const dt=new Date(d);return isNaN(dt)? "": dt.toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"});}

    function buildSections(){
      const c = document.getElementById("eco-news"); c.innerHTML="";
      filteredCats.forEach(cat=>{
        const sec = document.createElement("section");
        sec.dataset.cat = cat;
        sec.innerHTML = `<div class="category-label">${categoryNames[cat]}</div><div class="grid"></div>`;
        c.appendChild(sec);
      });
    }

    function isPlaceholderImage(url){
      return !url || /via\.placeholder\.com/.test(url);
    }

    function appendPage(page){
      if(loaded.has(page)) return;
      loaded.add(page);
      const container = document.getElementById("eco-news");
      filteredCats.forEach(cat=>{
        const catData = state.find(c=>c.category===cat);
        if(!catData) return;
        const grid = container.querySelector(`section[data-cat="${cat}"] .grid`);
        const slice = catData.items.slice((page-1)*perPage, page*perPage);
        slice.forEach(item=>{
          const card = document.createElement("div"); card.className="card";
          // media
          const media = document.createElement("div");
          if(item.image && !isPlaceholderImage(item.image)){
            const a = document.createElement("a"); a.href=item.link; a.target="_blank"; a.rel="noopener";
            const img = document.createElement("img"); img.className="thumb"; img.src=item.image; img.alt=item.title; img.loading="lazy"; img.decoding="async";
            a.appendChild(img); media.appendChild(a);
          } else {
            const box = document.createElement("div"); box.className="no-image-box";
            const t = document.createElement("div"); t.className="title";
            t.innerText = item.title.length>80 ? item.title.slice(0,77)+"..." : item.title;
            box.appendChild(t); media.appendChild(box);
          }
          // content
          const content = document.createElement("div"); content.className="card-content";
          content.innerHTML = `
            <a class="card-title" href="${item.link}" target="_blank" rel="noopener">${item.title}</a>
            <div class="meta"><div>${formatDate(item.pubDate)}</div><div class="source">${item.source}</div></div>
            <div class="snippet">${item.description}...</div>
            <div style="margin-top:6px;"><span class="source-badge">${item.source}</span></div>
          `;
          card.appendChild(media); card.appendChild(content);
          grid.appendChild(card);
        });
      });
      updatePageInfo();
    }

    function updatePageInfo(){
      const maxLen = Math.max(...state.map(c=>c.items.length));
      totalPages = Math.max(1, Math.ceil(maxLen/perPage));
      document.getElementById("page-info").innerText = `Pagina ${currentPage} di ${totalPages}`;
      if(currentPage>=totalPages) document.getElementById("end-of-feed").style.display="block";
    }

    // filtri
    document.addEventListener("click", e=>{
      const btn = e.target.closest(".filter-btn"); if(!btn) return;
      const cat = btn.dataset.cat;
      if(cat==="all"){
        const activate = !btn.classList.contains("active");
        document.querySelectorAll(".filter-btn").forEach(f=>{
          f.classList.toggle("active", f.dataset.cat==="all" ? activate : activate);
        });
        filteredCats = activate ? new Set(["Energia","SmartHome","Mobilita","Clima"]) : new Set();
      } else {
        btn.classList.toggle("active");
        btn.classList.contains("active") ? filteredCats.add(cat) : filteredCats.delete(cat);
        const allBtn = document.querySelector('.filter-btn[data-cat="all"]');
        const nonAll = Array.from(document.querySelectorAll('.filter-btn')).filter(f=>f.dataset.cat!=="all");
        allBtn.classList.toggle("active", nonAll.every(f=>f.classList.contains("active")));
      }
      currentPage=1; loaded.clear(); document.getElementById("end-of-feed").style.display="none";
      buildSections(); appendPage(1);
    });

    // infinite scroll
    let ticking=false;
    window.addEventListener("scroll", ()=>{
      if(ticking) return;
      ticking=true;
      requestAnimationFrame(()=>{
        if(window.innerHeight+window.scrollY >= document.body.offsetHeight-300){
          if(currentPage<totalPages){
            currentPage++; appendPage(currentPage);
          }
        }
        ticking=false;
      });
    });

    // fetch e init
    fetch(DATA_URL+"?t="+Date.now(), {cache:"no-store"})
      .then(r=>{ if(!r.ok) throw new Error("Impossibile scaricare feed"); return r.json(); })
      .then(d=>{
        state = d.categories.map(c=>({category:c.category, items:shuffle(c.items)}));
        document.getElementById("loader").style.display="none";
        document.getElementById("eco-news").style.display="block";
        buildSections(); appendPage(1);
      })
      .catch(err=>{
        document.getElementById("loader").style.display="none";
        const msg = document.createElement("div"); msg.className="error"; msg.innerText="Errore caricamento: "+err.message;
        document.querySelector(".wrapper").insertBefore(msg, document.getElementById("eco-news"));
        console.error(err);
      });
  </script>
</body>
</html>
